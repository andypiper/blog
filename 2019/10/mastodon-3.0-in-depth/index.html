<!doctype html><html lang><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=generator content="Hugo 0.124.1"><title>Mastodon 3.0 in-depth - Mastodon Blog</title>
<link rel="shortcut icon" type=image/png href=https://blog.joinmastodon.org/favicon.ico><link rel=canonical href=https://blog.joinmastodon.org/2019/10/mastodon-3.0-in-depth/><link rel=stylesheet href="https://blog.joinmastodon.org/css/styles.min.0ff7db6851f0326dde45ec59418290e69bcc519b34c9063e48b11e912473c286.css" integrity="sha256-D/fbaFHwMm3eRexZQYKQ5pvMUZs0yQY+SLEekSRzwoY="><meta property="og:locale" content><meta property="og:type" content="article"><meta property="og:title" content="Mastodon 3.0 in-depth"><meta property="og:description" content="Detailed notes on REST API changes, new deployment options, new admin settings and how to use them"><meta property="og:url" content="https://blog.joinmastodon.org/2019/10/mastodon-3.0-in-depth/"><meta property="og:site_name" content="Mastodon Blog"><meta name=article:author content="Eugen Rochko"><meta name=fediverse:creator content="Gargron@mastodon.social"></head><body><div class="bg-white py-12 sm:py-32"><div class="mx-auto max-w-7xl px-6 lg:px-8"><article class=h-entry><header class="max-w-prose mx-auto relative"><div class="flex flex-wrap items-center gap-x-4 text-xs mb-8"><a href=/ class="inline-flex items-center font-bold text-blurple-600 hover:underline hover:text-blurple-500"><svg class="icon arrow-small-left-icon w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentcolor" class="w-5 h-5"><path fill-rule="evenodd" d="M15 10a.75.75.0 01-.75.75H7.612l2.158 1.96a.75.75.0 11-1.04 1.08l-3.5-3.25a.75.75.0 010-1.08l3.5-3.25a.75.75.0 111.04 1.08L7.612 9.25h6.638A.75.75.0 0115 10z" clip-rule="evenodd"/></svg> Back</a>
<time class="text-gray-500 dt-published" datetime=2019-10-12T00:00:00Z>Oct 12, 2019</time><div class="flex flex-wrap items-center gap-x-4"><a class="relative z-10 rounded-full bg-nightshade-50 text-nightshade-900 px-3 py-1.5 font-medium hover:text-nightshade-600 whitespace-nowrap" href=/categories/guides>Guides</a></div></div><h1 class="p-name text-3xl font-bold tracking-tight text-gray-900 sm:text-4xl">Mastodon 3.0 in-depth</h1><h2 class="text-xl leading-8 text-gray-700 mt-2">New APIs, deployment options, and admin settings</h2><div class="relative mt-8 flex items-center gap-x-4"><div class="h-10 w-10 rounded-full bg-blurple-gradient relative overflow-hidden"><img src=https://blog.joinmastodon.org/authors/eugen-rochko.jpg alt class="absolute w-full h-full object-cover"></div><div class="text-sm leading-6"><p class="font-semibold text-gray-900"><span class="absolute inset-0"></span>
Eugen Rochko</p><p class=text-gray-600>CEO / Founder</p></div></div></header><main class="e-content max-w-prose mx-auto prose mt-8"><h3 id=new-rest-apis>New REST APIs</h3><p><strong>Profile directory</strong></p><p>The profile directory is a way to discover users who want to be discovered. To fetch the profile directory, access <code>GET /api/v1/directory</code> with the possible params <code>local</code> (boolean) and <code>order</code> (<code>new</code> or <code>active</code>). Pagination is accomplished using <code>offset</code> and <code>limit</code> params.</p><p><strong>Trends</strong></p><p>Hashtags that are used more than usual (and above a small minimal threshold) are &ldquo;trending&rdquo;. To fetch trending hashtags, access <code>GET /api/v1/trends</code>. Only 10 results are returned maximally but you can request fewer with <code>limit</code> param.</p><p><strong>Managing featured hashtags</strong></p><p>Users can feature hashtags on their public profile, which allows visitors to easily browse their public posts filed under those hashtags. These cannot yet be arbitrarily retrieved through the API, but there is now an API for managing the featured hashtags of the current user:</p><ul><li><code>GET /api/v1/featured_tags</code> to retrieve current user&rsquo;s featured hashtags</li><li><code>POST /api/v1/featured_tags</code> to create a new featured hashtag, specified by the param <code>name</code></li><li><code>DELETE /api/v1/featured_tags/:id</code> to delete a featured hashtag</li><li><code>GET /api/v1/featured_tags/suggestions</code> to retrieve the user&rsquo;s 10 most commonly used hashtags</li></ul><p>A featured hashtag contains the attributes <code>id</code>, <code>name</code>, <code>statuses_count</code> and <code>last_status_at</code>.</p><p><strong>Timeline position markers</strong></p><p>Apps can now synchronize their position in certain timelines between each other. Currently these are the home timeline and the notifications timeline. The web UI already implements this API and will save its position when closed.</p><p>To retrieve a map of markers with timeline names as keys, access <code>GET /api/v1/markers</code> . You must specify the desired timelines with the array param <code>timeline</code>. This is a slightly unusual structure in Mastodon&rsquo;s REST API so it deserves an example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#f1fa8c>&#34;home&#34;</span><span style=color:#ff79c6>:</span> {
</span></span><span style=display:flex><span>		<span style=color:#f1fa8c>&#34;last_read_id&#34;</span><span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>&#34;123...&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#f1fa8c>&#34;updated_at&#34;</span><span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>&#34;2019-10-04...&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#f1fa8c>&#34;version&#34;</span><span style=color:#ff79c6>:</span> <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span>	},
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#f1fa8c>&#34;notifications&#34;</span><span style=color:#ff79c6>:</span> {
</span></span><span style=display:flex><span>		...
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>To create a new marker, pass a map to <code>POST /api/v1/markers</code> with timeline names as keys (<code>home</code> and/or <code>notifications</code>), and an object containing the <code>last_read_id</code> for each timeline. Essentially, you pass it something like this, either encoded as JSON or using nested form/query params:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#f1fa8c>&#34;home&#34;</span><span style=color:#ff79c6>:</span> {
</span></span><span style=display:flex><span>		<span style=color:#f1fa8c>&#34;last_read_id&#34;</span><span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>&#34;567...&#34;</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>Hashtag autocomplete</strong></p><p>If you are using the <code>GET /api/v2/search</code> API for showing the user autocomplete for hashtags, you can now pass the <code>exclude_unreviewed</code> boolean param to limit the results to only those hashtags that have been looked at by the server&rsquo;s staff. This is a way to reduce junk and harmful results.</p><p><strong>Sign-up API in approval-required registrations mode</strong></p><p>You can now pass the <code>reason</code> param to <code>POST /api/v1/accounts</code>, containing the user&rsquo;s reason for wanting to join the server, which is useful when the server is in approval-required registrations mode. You can detect when that mode is active by the <code>approval_required</code> boolean attribute returned from <code>GET /api/v1/instance</code> (in conjunction with the <code>registrations</code> boolean attribute).</p><p><strong>Custom emoji categories</strong></p><p>New attribute <code>category</code> on custom emojis returned from <code>GET /api/v1/custom_emojis</code> contains a string with which emojis are supposed to be grouped when displayed in a picker UI.</p><p><strong>Displaying user&rsquo;s own votes in polls</strong></p><p>New attribute <code>own_votes</code> on polls contains an array of the user&rsquo;s choices (as indices corresponding to the <code>options</code> array).</p><h3 id=new-search-syntax-support>New search syntax support</h3><p>When ElasticSearch is enabled, you can use the following syntax to fine-tune your search:</p><ul><li>Surround keywords with double quotes (<code>"</code>) to search for the exact phrase</li><li>Prepend a keyword (or phrase) with minus sign (<code>-</code>) to exclude it from results</li></ul><p>It should be noted that the default operator has been changed from &ldquo;and&rdquo; to &ldquo;or&rdquo;, so by searching for &ldquo;foo bar&rdquo; you will get results that contain both &ldquo;foo&rdquo; and &ldquo;bar&rdquo; at the top, but also those that only contain &ldquo;foo&rdquo; and only contain &ldquo;bar&rdquo;. For this reason, there is also another new operator, the plus sign (<code>+</code>) which you can prepend to a keyword or phrase to make sure the results definitely contain it.</p><h3 id=health-check>Health check</h3><p>There is now <code>GET /health</code> endpoint for the web process which you can use with a monitoring service. The endpoint measures not only that the web process responds to requests but can successfully connect to the database and the cache as well.</p><h3 id=new-deployment-settings>New deployment settings</h3><p><strong>Reply-to header on e-mails</strong></p><p>If you want e-mails to be sent with a reply-to header, i.e. redirecting replies to those e-mails to a particular address, use the new <code>SMTP_REPLY_TO</code> environment variable. Mind that the reply-to header on moderation warning e-mails is set to the contact address configured in the admin UI.</p><p><strong>Secure mode</strong></p><p>Normally, all public resources are available without authentication or authorization. Because of this, it is hard to know who (in particular, which server, or which person) has accessed a particular resource, and impossible to deny that access to the ones you want to avoid. Secure mode requires authentication (via HTTP signatures) on all public resources, as well as disabling public REST API access (i.e. no access without access token, and no access with app-only access tokens, there has to be a user assigned to that access token). This means you always know who is accessing <em>any</em> resource on your server, and can deny that access using domain blocks.</p><p>Unfortunately, secure mode is not fully backwards-compatible with previous Mastodon versions. For this reason, it cannot be enabled by default. If you want to enable it, knowing that it may negatively impact communications with other servers, set the <code>AUTHORIZED_FETCH=true</code> environment variable.</p><p><strong>Whitelist mode</strong></p><p>Taking a step further than the secure mode, whitelist mode is meant for private servers. Our aim here are educational uses, such as schools and universities, where Mastodon could be used to provide a safe learning environment. When whitelist mode is enabled, no page is available without login, and any incoming or outgoing federation is ignored except for manually whitelisted domains. Domains can be whitelisted in the federation part of the admin UI. When whitelist mode is enabled, secure mode is also enabled.</p><p>To enable whitelist mode, set the <code>WHITELIST_MODE=true</code> environment variable. Please mind that this option was not designed for being switched on on already running servers. To clean an existing database of content that is not whitelisted, run <code>tootctl domains purge --whitelist-mode</code></p><p>Because whitelist mode essentially creates a silo, not unlike Twitter, Facebook, and other centralized services, we do not recommend running public servers in whitelist mode.</p><h3 id=new-command-line-tools>New command-line tools</h3><p>Please mind that if you find any of the below descriptions insufficient, you can always append <code>--help</code> to whichever command you&rsquo;re interested in and receive the most detailed information about the usage of that command and the available options.</p><p><strong>Parallization and progress</strong></p><p>Commands that used to accept a <code>--background</code> flag for Sidekiq-based execution have been changed to instead support a <code>--concurrency</code> (or <code>-c</code>) flag specifying the number of threads to use for parallel execution.</p><p>Instead of printing dots to signal progress, real progress bars are now displayed, with the number of processed items and estimated time to completion.</p><p><strong>Cleaning up old link preview cards</strong></p><p>To remove thumbnails from older link preview cards, run <code>tootctl preview_cards remove</code>, specifying age with <code>--days</code> just like for media removal.</p><p><strong>Re-downloading removed media attachments</strong></p><p>If you need to re-download media attachments, run <code>tootctl media refresh</code>. You can either re-download media attachments from a specific <code>--status</code>, from a specific <code>--account</code>, or from an entire <code>--domain</code>.</p><p><strong>Re-counting counters</strong></p><p>Sometimes various counters in Mastodon get out of sync with reality. To fix account counters (e.g. followers, following, toots), run <code>tootctl cache recount accounts</code>. This should not take very long. To fix status counters (e.g. reblogs, favourites, replies), run <code>tootctl cache recount statuses</code>. This may take a lot longer.</p><h3 id=new-admin-uis>New admin UIs</h3><p><strong>Trends</strong></p><p>Hashtags will not trend without your approval. Whenever a hashtag is beginning to trend, you receive a notification e-mail asking to review it. You can disable those e-mails from your personal e-mail notification preferences. You can disable the trends feature altogether from admin settings. Or you can choose to auto-approve hashtags instead, which may be suitable for trusted communities.</p><p>The hashtags area in the admin UI has been updated. When looking at hashtags that are pending review, you can approve or reject them in batches. From individual hashtag view, you can control whether the hashtag can trend, whether it can appear on the profile directory and in searches, or whether it can be used at all. You will also see which servers you know about are contributing how much to that hashtag&rsquo;s usage to help you determine whether to let it trend or not.</p><p><strong>Including reported toots in warning e-mails</strong></p><p>If you want to perform an action or warning against a user related to a report, you can choose if the toots that were in that report should be included in the e-mail the user will get about that action or warning. This will provide more clarity to the user about how they broke your rules.</p><p><strong>Table of contents on about page</strong></p><p>The about page of your server will now auto-generate a table of contents based on the structure of your extended description HTML. It is recommended to have a <code>h1</code> tag, which will not be reflected on the table of contents, to give the entire page a title, then <code>h2</code> and <code>h3</code> tags for the different sections. Make sure your HTML is valid, otherwise the table of contents may not work as expected.</p><p><strong>Public and private domain blocks information</strong></p><p>You can now add comments to domain blocks. Private comments are for other staff members only. From the admin settings, you can choose if domain blocks should be disclosed publicly or to logged-in users only, or not at all. If you choose to disclose them, they will appear on the about page, below your extended description. You can use the public comments to give public reasons for your decisions.</p><p><strong>Custom emoji categories</strong></p><p>The custom emojis area in the admin UI has been updated. You can now assign emojis to custom categories and perform batch actions on them such as copying, deleting, or unlisting.</p><p><strong>Spam checks</strong></p><p>When a user mentions someone who isn&rsquo;t following them <em>and</em> it&rsquo;s not a reply to something directed at that user, their message is run through a simplistic spam check which detects repeating messages. When spam is detected, a new report is created automatically. If that was a mistake, you can mark the report as resolved and it will exempt that user from future spam checks. You can disable the spam check feature from admin settings.</p></main></article><div class="grid grid-cols-1 gap-x-8 gap-y-16 border-t border-gray-200 pt-10 sm:mt-16 sm:pt-16 md:grid-cols-2 h-feed"><a href=/2019/10/adding-sign-up-to-your-mastodon-app/ class="group flex lg:max-w-xl flex-col items-start justify-between h-entry u-url" rel=bookmark><div class=w-full><div class="flex items-center gap-x-4 text-xs"><time class="text-gray-500 dt-published" datetime=2019-10-12T00:00:00Z>Oct 12, 2019
</time><span class="relative z-10 rounded-full bg-nightshade-50 text-nightshade-900 px-3 py-1.5 font-medium">Guides</span></div><div class="w-full relative aspect-[3/2] w-full overflow-hidden rounded-md my-4 bg-blurple-gradient shadow-lg ring-blurple-500 group-hover:ring-2"></div><div class=relative><h3 class="mt-3 text-lg font-semibold leading-6 text-gray-900 group-hover:text-blurple-500 p-name"><span class="absolute inset-0"></span>
Adding sign-up to your Mastodon app</h3><p class="mt-5 line-clamp-3 text-sm leading-6 text-gray-600 p-summary">Since Mastodon 2.7, it is actually possible to let users sign up through your app, instead of asking them to go to a Mastodon website directly and then return. Let&amp;rsquo;s go over how this can be done.</p></div></div><div class="relative mt-8 flex items-center gap-x-4"><div class="h-10 w-10 rounded-full bg-blurple-gradient relative overflow-hidden"><img src=https://blog.joinmastodon.org/authors/eugen-rochko.jpg alt class="absolute w-full h-full object-cover"></div><div class="text-sm leading-6"><p class="font-semibold text-gray-900"><span class="absolute inset-0"></span>
Eugen Rochko</p><p class=text-gray-600>CEO / Founder</p></div></div></a><a href=/2019/10/mastodon-3.0/ class="group flex lg:max-w-xl flex-col items-start justify-between h-entry u-url" rel=bookmark><div class=w-full><div class="flex items-center gap-x-4 text-xs"><time class="text-gray-500 dt-published" datetime=2019-10-11T00:00:00Z>Oct 11, 2019
</time><span class="relative z-10 rounded-full bg-nightshade-50 text-nightshade-900 px-3 py-1.5 font-medium">New Features</span></div><div class="w-full relative aspect-[3/2] w-full overflow-hidden rounded-md my-4 bg-blurple-gradient shadow-lg ring-blurple-500 group-hover:ring-2"><img src=/2019/10/mastodon-3.0/hero.png alt class="absolute w-full h-full object-cover"></div><div class=relative><h3 class="mt-3 text-lg font-semibold leading-6 text-gray-900 group-hover:text-blurple-500 p-name"><span class="absolute inset-0"></span>
Mastodon 3.0</h3><p class="mt-5 line-clamp-3 text-sm leading-6 text-gray-600 p-summary">In this exciting new release: Moving accounts, trending hashtags, private servers and more!</p></div></div><div class="relative mt-8 flex items-center gap-x-4"><div class="h-10 w-10 rounded-full bg-blurple-gradient relative overflow-hidden"></div><div class="text-sm leading-6"><p class="font-semibold text-gray-900"><span class="absolute inset-0"></span>
Eleanor</p><p class=text-gray-600>Guest</p></div></div></a></div><footer class="border-t border-gray-200 pt-10 mt-10 text-gray-600"><div class="flex justify-between"><p class=flex-0><a class=hover:underline href=https://joinmastodon.org>Mastodon</a> · <a class=hover:underline href=https://github.com/mastodon/blog/blob/master/content//posts/2019-10-04_mastodon-3.0-api-and-deployment-changes>View source</a> · <a class=hover:underline href=https://creativecommons.org/licenses/by-sa/4.0/>CC BY-SA 4.0</a> · <a class=hover:underline href=https://joinmastodon.org/imprint>Imprint</a></p><p class="flex-0 justify-end flex gap-x-4 items-center"><a class=hover:text-blurple-500 href=https://mastodon.social/@Mastodon target=_blank><svg class="icon mastodon-icon w-5 h-5" width="74" height="79" viewBox="0 0 74 79" fill="currentcolor" xmlns="http://www.w3.org/2000/svg"><path d="M73.7014 17.9592C72.5616 9.62034 65.1774 3.04876 56.424 1.77536 54.9472 1.56019 49.3517.7771 36.3901.7771H36.2933c-12.9652.0-15.7468.78309-17.2236.99826C10.56 3.01348 2.78877 8.91838.903306 17.356-.00357857 21.5113-.100361 26.1181.068112 30.3439.308275 36.404.354874 42.4535.91406 48.489c.38658 4.009 1.06096 7.9861 2.01809 11.9015 1.79226 7.2312 9.04735 13.249 16.15545 15.704C26.6979 78.6548 34.8821 79.0799 42.724 77.3221 43.5866 77.1245 44.4398 76.8953 45.2833 76.6342 47.1867 76.0381 49.4199 75.3714 51.0616 74.2003 51.0841 74.1839 51.1026 74.1627 51.1156 74.1382 51.1286 74.1138 51.1359 74.0868 51.1368 74.0592V68.2108C51.1364 68.185 51.1302 68.1596 51.1185 68.1365 51.1069 68.1134 51.0902 68.0932 51.0695 68.0773 51.0489 68.0614 51.0249 68.0503 50.9994 68.0447 50.9738 68.0391 50.9473 68.0392 50.9218 68.045c-5.0242 1.181-10.1727 1.773-15.3382 1.7637C26.694 69.8087 24.3031 65.6569 23.6184 63.9285 23.0681 62.4347 22.7186 60.8764 22.5789 59.2934 22.5775 59.2669 22.5825 59.2403 22.5934 59.216 22.6043 59.1916 22.621 59.1702 22.6419 59.1533 22.6629 59.1365 22.6876 59.1248 22.714 59.1191 22.7404 59.1134 22.7678 59.1139 22.794 59.1206 27.7345 60.2936 32.799 60.8856 37.8813 60.8843c1.2223.0 2.441.0 3.6634-.0317000000000007C46.6562 60.7115 52.0437 60.454 57.0728 59.4874 57.1983 59.4628 57.3237 59.4416 57.4313 59.4098c7.9325-1.4991 15.4815-6.2047 16.2486-18.1203C73.7086 40.8204 73.7803 36.3758 73.7803 35.889 73.7839 34.2347 74.3216 24.1533 73.7014 17.9592zM61.4925 47.6918H53.1514V27.5855c0-4.2329-1.7923-6.3917-5.4378-6.3917-4.0075.0-6.0148 2.5538-6.0148 7.5981V39.7974h-8.291V28.7919c0-5.0443-2.0109-7.5981-6.0184-7.5981-3.624.0-5.4342 2.1588-5.4378 6.3917V47.6918h-8.334V26.9752c0-4.2329 1.0981-7.5957 3.2942-10.0884 2.2654-2.4868 5.237-3.7637 8.9255-3.7637 4.2691.0 7.4952 1.6155 9.6459 4.8431L37.5587 21.3949l2.079-3.4287c2.1507-3.2276 5.3768-4.8431 9.6388-4.8431 3.6849.0 6.6564 1.2769 8.929 3.7637 2.1962 2.4904 3.2942 5.8532 3.2942 10.0884L61.4925 47.6918z" fill="inherit"/></svg></a>
<a class=hover:text-blurple-500 href=/index.xml target=_blank><svg class="icon rss-icon w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentcolor"><path d="M3.75 3A.75.75.0 003 3.75v.5c0 .414.336.75.75.75H4c6.075.0 11 4.925 11 11v.25c0 .414.336.75.75.75h.5a.75.75.0 00.75-.75V16C17 8.82 11.18 3 4 3h-.25z"/><path d="M3 8.75A.75.75.0 013.75 8H4a8 8 0 018 8v.25a.75.75.0 01-.75.75h-.5a.75.75.0 01-.75-.75V16a6 6 0 00-6-6h-.25A.75.75.0 013 9.25v-.5zM7 15a2 2 0 11-4 0 2 2 0 014 0z"/></svg></a></p></div></footer></div></div></body></html>